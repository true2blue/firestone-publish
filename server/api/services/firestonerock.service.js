"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _logger = _interopRequireDefault(require("../../common/logger"));

var _child_process = _interopRequireDefault(require("child_process"));

var _util = _interopRequireDefault(require("util"));

var _http = _interopRequireDefault(require("http"));

var _https = _interopRequireDefault(require("https"));

var _querystring = _interopRequireDefault(require("querystring"));

var _zlib = require("zlib");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class FireStoneRockService {
  constructor() {
    this.exec = _util.default.promisify(_child_process.default.exec);
    this.options = {
      'method': 'POST',
      'hostname': 'mncg.10jqka.com.cn',
      'path': '/cgiwt/delegate/qryChengjiao',
      'headers': {
        'Accept': ' application/json, text/javascript, */*; q=0.01',
        'Accept-Encoding': ' gzip, deflate, br',
        'Accept-Language': ' en,zh-CN;q=0.9,zh;q=0.8',
        'Connection': ' keep-alive',
        'Content-Length': ' 0',
        'Host': ' mncg.10jqka.com.cn',
        'Origin': ' https://mncg.10jqka.com.cn',
        'Referer': ' https://mncg.10jqka.com.cn/cgiwt/index/index',
        'Sec-Fetch-Dest': ' empty',
        'Sec-Fetch-Mode': ' cors',
        'Sec-Fetch-Site': ' same-origin',
        'User-Agent': ' Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'X-Requested-With': ' XMLHttpRequest',
        'sec-ch-ua': ' "Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
        'sec-ch-ua-mobile': ' ?0',
        'sec-ch-ua-platform': ' "Windows"'
      }
    };
    this.dfcf_options = {
      'hostname': 'jy.xzsec.com',
      'port': 443,
      'method': 'POST',
      'headers': {
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'Accept-Encoding': 'gzip, deflate, br',
        'Accept-Language': 'en-US,en;q=0.9',
        'Connection': 'keep-alive',
        'Referer': 'https://jy.xzsec.com/Trade/Sale',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Host': 'jy.xzsec.com',
        'Origin': 'https://jy.xzsec.com',
        'sec-ch-ua': '"Chromium";v="94", "Google Chrome";v="94", ";Not A Brand";v="99"',
        'sec-ch-ua-mobile': '?0',
        'sec-ch-ua-platform': '"Windows"',
        'Sec-Fetch-Dest': 'empty',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Site': 'same-origin',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.71 Safari/537.36',
        'X-Requested-With': 'XMLHttpRequest'
      }
    };
  }

  async createNewFirerock(codes, tradeId, isMock) {
    let msg = `start the firestonerock service code=${codes}, tradeId=${tradeId}, isMock=${isMock}`;

    _logger.default.info(msg);

    if (process.env.ENABLE_FIREROCK === 'true') {
      let seconds = '"2,5,8,11,14,17,20,23,26,29,32,35,38,41,44,47,50,53,56,59"';

      if (codes[0] == 'N/A') {
        seconds = '3';
      }

      this.exec(`shell\\runfirerock ${tradeId} ${seconds} ${isMock}`);
      return new Promise((resolve, reject) => {
        resolve({
          'success': msg
        });
      });
    } else {
      return Promise.resolve({
        'success': msg,
        'message': 'FIREROCK is disable, ignore createNewFirerock'
      });
    }
  }

  async start_heart_beat(headers) {
    if (process.env.ENABLE_THS_HEART_BEAT === 'true') {
      Object.assign(this.options.headers, headers);
      return new Promise((resolve, reject) => {
        console.log(this.options);

        let req = _http.default.request(this.options, res => {
          var chunks = [];
          res.on('data', chunk => {
            chunks.push(chunk);
          });
          res.on("end", function (chunk) {
            let body = Buffer.concat(chunks);
            let result = body.toString();

            _logger.default.info(`send heart beat to ths get response = ${result}`);

            resolve(JSON.parse(result));
          });
          res.on("error", function (error) {
            _logger.default.error(`failed to parse the heart beat result = ${error}`);

            reject(error);
          });
        });

        req.on('error', e => {
          _logger.default.error(`send heart beat to ths error, e = ${e}`);

          reject(e);
        });
        req.end();
      });
    } else {
      return Promise.resolve({
        errorcode: 0,
        message: 'THS_HEART_BEAT is disable, ignore the heart beat'
      });
    }
  }

  async start_heart_beat_dfcf(headers, validatekey) {
    this.dfcf_options['path'] = '/Search/GetDealData?validatekey=' + validatekey;
    headers['gw_reqtimestamp'] = new Date().getTime();
    Object.assign(this.dfcf_options.headers, headers);
    return new Promise((resolve, reject) => {
      let req = _https.default.request(this.dfcf_options, res => {
        const encoding = res.headers['content-encoding'];
        let stream = res; // If the response is gzipped, create a gunzip stream

        if (encoding && encoding.includes('gzip')) {
          stream = res.pipe((0, _zlib.createGunzip)());
        }

        var chunks = [];
        stream.on('data', chunk => {
          chunks.push(chunk);
        });
        stream.on("end", function (chunk) {
          let body = Buffer.concat(chunks);
          let result = body.toString('utf-8');

          _logger.default.info(`send heart beat to dfcf get response = ${result}`);

          resolve(JSON.parse(result));
        });
        stream.on("error", function (error) {
          _logger.default.error(`failed to parse the heart beat result = ${error}`);

          reject(error);
        });
      });

      req.on('error', e => {
        _logger.default.error(`send heart beat to dfcf error, e = ${e}`);

        reject(e);
      });
      req.write(_querystring.default.stringify({
        'qqhs': '10',
        'dwc': ''
      }));
      req.end();
    });
  }

}

var _default = new FireStoneRockService();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9hcGkvc2VydmljZXMvZmlyZXN0b25lcm9jay5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIkZpcmVTdG9uZVJvY2tTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJleGVjIiwidXRpbCIsInByb21pc2lmeSIsImNoaWxkX3Byb2Nlc3MiLCJvcHRpb25zIiwiZGZjZl9vcHRpb25zIiwiY3JlYXRlTmV3RmlyZXJvY2siLCJjb2RlcyIsInRyYWRlSWQiLCJpc01vY2siLCJtc2ciLCJsIiwiaW5mbyIsInByb2Nlc3MiLCJlbnYiLCJFTkFCTEVfRklSRVJPQ0siLCJzZWNvbmRzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzdGFydF9oZWFydF9iZWF0IiwiaGVhZGVycyIsIkVOQUJMRV9USFNfSEVBUlRfQkVBVCIsIk9iamVjdCIsImFzc2lnbiIsImNvbnNvbGUiLCJsb2ciLCJyZXEiLCJodHRwIiwicmVxdWVzdCIsInJlcyIsImNodW5rcyIsIm9uIiwiY2h1bmsiLCJwdXNoIiwiYm9keSIsIkJ1ZmZlciIsImNvbmNhdCIsInJlc3VsdCIsInRvU3RyaW5nIiwiSlNPTiIsInBhcnNlIiwiZXJyb3IiLCJlIiwiZW5kIiwiZXJyb3Jjb2RlIiwibWVzc2FnZSIsInN0YXJ0X2hlYXJ0X2JlYXRfZGZjZiIsInZhbGlkYXRla2V5IiwiRGF0ZSIsImdldFRpbWUiLCJodHRwcyIsImVuY29kaW5nIiwic3RyZWFtIiwiaW5jbHVkZXMiLCJwaXBlIiwid3JpdGUiLCJxdWVyeXN0cmluZyIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsb0JBQU4sQ0FBMkI7QUFFdkJDLEVBQUFBLFdBQVcsR0FBRztBQUNWLFNBQUtDLElBQUwsR0FBWUMsY0FBS0MsU0FBTCxDQUFlQyx1QkFBY0gsSUFBN0IsQ0FBWjtBQUNBLFNBQUtJLE9BQUwsR0FBZTtB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QUFBQSxNQUFNLENBQUNyQixFQUFQLENBQVUsT0FBVixFQUFtQixVQUFVVSxLQUFWLEVBQWlCO0FBQ2hDL0IsMEJBQUUrQixLQUFGLENBQVMsMkNBQTBDQSxLQUFNLEVBQXpEOztBQUNBdkIsVUFBQUEsTUFBTSxDQUFDdUIsS0FBRCxDQUFOO0FBQ0gsU0FIRDtBQUlQLE9BekJTLENBQVY7O0FBMkJBZixNQUFBQSxHQUFHLENBQUNLLEVBQUosQ0FBTyxPQUFQLEVBQWlCVyxDQUFELElBQU87QUFDbkJoQyx3QkFBRStCLEtBQUYsQ0FBUyxzQ0FBcUNDLENBQUUsRUFBaEQ7O0FBQ0F4QixRQUFBQSxNQUFNLENBQUN3QixDQUFELENBQU47QUFDSCxPQUhEO0FBS0FoQixNQUFBQSxHQUFHLENBQUM2QixLQUFKLENBQVVDLHFCQUFZQyxTQUFaLENBQXNCO0FBQzVCLGdCQUFRLElBRG9CO0FBRTVCLGVBQU87QUFGcUIsT0FBdEIsQ0FBVjtBQUtBL0IsTUFBQUEsR0FBRyxDQUFDaUIsR0FBSjtBQUNILEtBdkNNLENBQVA7QUF3Q0g7O0FBekpzQjs7ZUE2SlosSUFBSTlDLG9CQUFKLEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbCBmcm9tICcuLi8uLi9jb21tb24vbG9nZ2VyJztcclxuaW1wb3J0IGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XHJcbmltcG9ydCB1dGlsIGZyb20gJ3V0aWwnXHJcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnXHJcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcydcclxuaW1wb3J0IHF1ZXJ5c3RyaW5nIGZyb20gJ3F1ZXJ5c3RyaW5nJ1xyXG5pbXBvcnQgeyBjcmVhdGVHdW56aXAgfSBmcm9tICd6bGliJztcclxuXHJcbmNsYXNzIEZpcmVTdG9uZVJvY2tTZXJ2aWNlIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmV4ZWMgPSB1dGlsLnByb21pc2lmeShjaGlsZF9wcm9jZXNzLmV4ZWMpXHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0ge1xyXG4gICAgICAgICAgICAnbWV0aG9kJzogJ1BPU1QnLFxyXG4gICAgICAgICAgICAnaG9zdG5hbWUnOiAnbW5jZy4xMGpxa2EuY29tLmNuJyxcclxuICAgICAgICAgICAgJ3BhdGgnOiAnL2NnaXd0L2RlbGVnYXRlL3FyeUNoZW5namlhbycsXHJcbiAgICAgICAgICAgICdoZWFkZXJzJzoge1xyXG4gICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICcgYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0LCAqLyo7IHE9MC4wMScsXHJcbiAgICAgICAgICAgICAgICAnQWNjZXB0LUVuY29kaW5nJzogJyBnemlwLCBkZWZsYXRlLCBicicsXHJcbiAgICAgICAgICAgICAgICAnQWNjZXB0LUxhbmd1YWdlJzogJyBlbix6aC1DTjtxPTAuOSx6aDtxPTAuOCcsXHJcbiAgICAgICAgICAgICAgICAnQ29ubmVjdGlvbic6ICcga2VlcC1hbGl2ZScsXHJcbiAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiAnIDAnLFxyXG4gICAgICAgICAgICAgICAgJ0hvc3QnOiAnIG1uY2cuMTBqcWthLmNvbS5jbicsXHJcbiAgICAgICAgICAgICAgICAnT3JpZ2luJzogJyBodHRwczovL21uY2cuMTBqcWthLmNvbS5jbicsXHJcbiAgICAgICAgICAgICAgICAnUmVmZXJlcic6ICcgaHR0cHM6Ly9tbmNnLjEwanFrYS5jb20uY24vY2dpd3QvaW5kZXgvaW5kZXgnLFxyXG4gICAgICAgICAgICAgICAgJ1NlYy1GZXRjaC1EZXN0JzogJyBlbXB0eScsXHJcbiAgICAgICAgICAgICAgICAnU2VjLUZldGNoLU1vZGUnOiAnIGNvcnMnLFxyXG4gICAgICAgICAgICAgICAgJ1NlYy1GZXRjaC1TaXRlJzogJyBzYW1lLW9yaWdpbicsXHJcbiAgICAgICAgICAgICAgICAnVXNlci1BZ2VudCc6ICcgTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEyMC4wLjAuMCBTYWZhcmkvNTM3LjM2JyxcclxuICAgICAgICAgICAgICAgICdYLVJlcXVlc3RlZC1XaXRoJzogJyBYTUxIdHRwUmVxdWVzdCcsXHJcbiAgICAgICAgICAgICAgICAnc2VjLWNoLXVhJzogJyBcIk5vdF9BIEJyYW5kXCI7dj1cIjhcIiwgXCJDaHJvbWl1bVwiO3Y9XCIxMjBcIiwgXCJHb29nbGUgQ2hyb21lXCI7dj1cIjEyMFwiJyxcclxuICAgICAgICAgICAgICAgICdzZWMtY2gtdWEtbW9iaWxlJzogJyA/MCcsXHJcbiAgICAgICAgICAgICAgICAnc2VjLWNoLXVhLXBsYXRmb3JtJzogJyBcIldpbmRvd3NcIidcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5kZmNmX29wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICdob3N0bmFtZSc6ICdqeS54enNlYy5jb20nLFxyXG4gICAgICAgICAgICAncG9ydCc6IDQ0MyxcclxuICAgICAgICAgICAgJ21ldGhvZCc6ICdQT1NUJyxcclxuICAgICAgICAgICAgJ2hlYWRlcnMnOiB7XHJcbiAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCwgKi8qOyBxPTAuMDEnLFxyXG4gICAgICAgICAgICAgICAgJ0FjY2VwdC1FbmNvZGluZyc6ICdnemlwLCBkZWZsYXRlLCBicicsXHJcbiAgICAgICAgICAgICAgICAnQWNjZXB0LUxhbmd1YWdlJzogJ2VuLVVTLGVuO3E9MC45JyxcclxuICAgICAgICAgICAgICAgICdDb25uZWN0aW9uJzogJ2tlZXAtYWxpdmUnLFxyXG4gICAgICAgICAgICAgICAgJ1JlZmVyZXInOiAnaHR0cHM6Ly9qeS54enNlYy5jb20vVHJhZGUvU2FsZScsXHJcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXHJcbiAgICAgICAgICAgICAgICAnSG9zdCc6ICdqeS54enNlYy5jb20nLFxyXG4gICAgICAgICAgICAgICAgJ09yaWdpbic6ICdodHRwczovL2p5Lnh6c2VjLmNvbScsXHJcbiAgICAgICAgICAgICAgICAnc2VjLWNoLXVhJzogJ1wiQ2hyb21pdW1cIjt2PVwiOTRcIiwgXCJHb29nbGUgQ2hyb21lXCI7dj1cIjk0XCIsIFwiO05vdCBBIEJyYW5kXCI7dj1cIjk5XCInLFxyXG4gICAgICAgICAgICAgICAgJ3NlYy1jaC11YS1tb2JpbGUnOiAnPzAnLFxyXG4gICAgICAgICAgICAgICAgJ3NlYy1jaC11YS1wbGF0Zm9ybSc6ICdcIldpbmRvd3NcIicsXHJcbiAgICAgICAgICAgICAgICAnU2VjLUZldGNoLURlc3QnOiAnZW1wdHknLFxyXG4gICAgICAgICAgICAgICAgJ1NlYy1GZXRjaC1Nb2RlJzogJ2NvcnMnLFxyXG4gICAgICAgICAgICAgICAgJ1NlYy1GZXRjaC1TaXRlJzogJ3NhbWUtb3JpZ2luJyxcclxuICAgICAgICAgICAgICAgICdVc2VyLUFnZW50JzogJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS85NC4wLjQ2MDYuNzEgU2FmYXJpLzUzNy4zNicsXHJcbiAgICAgICAgICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgY3JlYXRlTmV3RmlyZXJvY2soY29kZXMsIHRyYWRlSWQsIGlzTW9jaykge1xyXG4gICAgICAgIGxldCBtc2cgPSBgc3RhcnQgdGhlIGZpcmVzdG9uZXJvY2sgc2VydmljZSBjb2RlPSR7Y29kZXN9LCB0cmFkZUlkPSR7dHJhZGVJZH0sIGlzTW9jaz0ke2lzTW9ja31gO1xyXG4gICAgICAgIGwuaW5mbyhtc2cpO1xyXG4gICAgICAgIGlmKHByb2Nlc3MuZW52LkVOQUJMRV9GSVJFUk9DSyA9PT0gJ3RydWUnKXtcclxuICAgICAgICAgICAgbGV0IHNlY29uZHMgPSAnXCIyLDUsOCwxMSwxNCwxNywyMCwyMywyNiwyOSwzMiwzNSwzOCw0MSw0NCw0Nyw1MCw1Myw1Niw1OVwiJztcclxuICAgICAgICAgICAgaWYoY29kZXNbMF0gPT0gJ04vQScpe1xyXG4gICAgICAgICAgICAgICAgc2Vjb25kcyA9ICczJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmV4ZWMoYHNoZWxsXFxcXHJ1bmZpcmVyb2NrICR7dHJhZGVJZH0gJHtzZWNvbmRzfSAke2lzTW9ja31gKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoeyAnc3VjY2Vzcyc6IG1zZyB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyAnc3VjY2Vzcyc6IG1zZywgJ21lc3NhZ2UnIDogJ0ZJUkVST0NLIGlzIGRpc2FibGUsIGlnbm9yZSBjcmVhdGVOZXdGaXJlcm9jayd9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBzdGFydF9oZWFydF9iZWF0KGhlYWRlcnMpIHtcclxuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuRU5BQkxFX1RIU19IRUFSVF9CRUFUID09PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdGlvbnMuaGVhZGVycywgaGVhZGVycylcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMub3B0aW9ucylcclxuICAgICAgICAgICAgICAgIGxldCByZXEgPSBodHRwLnJlcXVlc3QodGhpcy5vcHRpb25zLCAocmVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNodW5rcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXMub24oJ2RhdGEnLCAoY2h1bmspID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtzLnB1c2goY2h1bmspO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXMub24oXCJlbmRcIiwgZnVuY3Rpb24gKGNodW5rKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBib2R5ID0gQnVmZmVyLmNvbmNhdChjaHVua3MpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gYm9keS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsLmluZm8oYHNlbmQgaGVhcnQgYmVhdCB0byB0aHMgZ2V0IHJlc3BvbnNlID0gJHtyZXN1bHR9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoSlNPTi5wYXJzZShyZXN1bHQpKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGwuZXJyb3IoYGZhaWxlZCB0byBwYXJzZSB0aGUgaGVhcnQgYmVhdCByZXN1bHQgPSAke2Vycm9yfWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICByZXEub24oJ2Vycm9yJywgKGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsLmVycm9yKGBzZW5kIGhlYXJ0IGJlYXQgdG8gdGhzIGVycm9yLCBlID0gJHtlfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlcS5lbmQoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZXJyb3Jjb2RlOiAwLCBtZXNzYWdlOiAnVEhTX0hFQVJUX0JFQVQgaXMgZGlzYWJsZSwgaWdub3JlIHRoZSBoZWFydCBiZWF0JyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFzeW5jIHN0YXJ0X2hlYXJ0X2JlYXRfZGZjZihoZWFkZXJzLCB2YWxpZGF0ZWtleSkge1xyXG4gICAgICAgIHRoaXMuZGZjZl9vcHRpb25zWydwYXRoJ10gPSAnL1NlYXJjaC9HZXREZWFsRGF0YT92YWxpZGF0ZWtleT0nICsgdmFsaWRhdGVrZXk7XHJcbiAgICAgICAgaGVhZGVyc1snZ3dfcmVxdGltZXN0YW1wJ10gPSBuZXcgRGF0ZSgpLmdldFRpbWUoKVxyXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5kZmNmX29wdGlvbnMuaGVhZGVycywgaGVhZGVycyk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgbGV0IHJlcSA9IGh0dHBzLnJlcXVlc3QodGhpcy5kZmNmX29wdGlvbnMsIChyZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVuY29kaW5nID0gcmVzLmhlYWRlcnNbJ2NvbnRlbnQtZW5jb2RpbmcnXTtcclxuICAgICAgICAgICAgICAgIGxldCBzdHJlYW0gPSByZXM7XHJcbiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmVzcG9uc2UgaXMgZ3ppcHBlZCwgY3JlYXRlIGEgZ3VuemlwIHN0cmVhbVxyXG4gICAgICAgICAgICAgICAgaWYgKGVuY29kaW5nICYmIGVuY29kaW5nLmluY2x1ZGVzKCdnemlwJykpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdHJlYW0gPSByZXMucGlwZShjcmVhdGVHdW56aXAoKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGNodW5rcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLCAoY2h1bmspID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtzLnB1c2goY2h1bmspO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBzdHJlYW0ub24oXCJlbmRcIiwgZnVuY3Rpb24gKGNodW5rKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBib2R5ID0gQnVmZmVyLmNvbmNhdChjaHVua3MpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gYm9keS50b1N0cmluZygndXRmLTgnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbC5pbmZvKGBzZW5kIGhlYXJ0IGJlYXQgdG8gZGZjZiBnZXQgcmVzcG9uc2UgPSAke3Jlc3VsdH1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShKU09OLnBhcnNlKHJlc3VsdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBzdHJlYW0ub24oXCJlcnJvclwiLCBmdW5jdGlvbiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbC5lcnJvcihgZmFpbGVkIHRvIHBhcnNlIHRoZSBoZWFydCBiZWF0IHJlc3VsdCA9ICR7ZXJyb3J9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICByZXEub24oJ2Vycm9yJywgKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGwuZXJyb3IoYHNlbmQgaGVhcnQgYmVhdCB0byBkZmNmIGVycm9yLCBlID0gJHtlfWApO1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJlcS53cml0ZShxdWVyeXN0cmluZy5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgJ3FxaHMnOiAnMTAnLFxyXG4gICAgICAgICAgICAgICAgJ2R3Yyc6ICcnXHJcbiAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgICAgIHJlcS5lbmQoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IG5ldyBGaXJlU3RvbmVSb2NrU2VydmljZSgpIl19